# VBT Analyzer Project Handover Documentation

## 1. プロジェクト概要
本プロジェクト「VBT Analyzer」は、単眼RGBカメラ（Webカメラまたは動画ファイル）のみを使用して、バーベルエクササイズ（主にベンチプレスやスクワット）の**挙上速度（Velocity Based Training - VBT）**をリアルタイムで計測・分析するアプリケーションです。

### 主な機能
*   **Pose Estimation**: MediaPipeを使用し、手首の位置からバーの軌道を追跡。
*   **自動キャリブレーション**: ユーザーが静止している状態を検知し、左右の手首間距離（デフォルト81cm）を基準にピクセル→メートルの変換係数を自動算出。
*   **リアルタイムフィードバック**:
    *   **Velocity**: 現在の挙上速度 (m/s)。
    *   **Rep Counting**: 状態遷移マシン（Waiting -> Eccentric -> Concentric）によるレップ数の自動カウント。
    *   **Fatigue Indicator**: 1レップ目の最大速度を基準とし、速度低下率（Drop-off）に応じて画面上のテキスト色を変化（緑→黄→赤）。
*   **レポート出力**: アプリ終了時に、レップごとのピーク速度と疲労度を記録したテキストファイルを出力。

## 2. 環境構築 (Requirements)
開発・実行に必要な環境です。

*   **Python**: 3.8+
*   **Libraries**:
    ```bash
    pip install mediapipe opencv-python numpy matplotlib
    ```
    *(現在の環境では `conda activate yolo` で動作確認済み)*

## 3. ファイル構成

| ファイル名 | 説明 |
| :--- | :--- |
| **`app.py`** | **メインアプリケーション**。映像の取得、各モジュールの統括、描画処理（GUI）を担当。 |
| **`pose_estimator.py`** | **姿勢推定モジュール**。MediaPipe Poseのラッパー。画像から関節座標（ランドマーク）を抽出して辞書形式で返す。 |
| **`vbt_analyzer.py`** | **分析ロジックコア**。速度計算、スムージング、レップ判定（状態遷移）、疲労度計算、レポート生成を担当。 |
| `README.md` | 簡易的な利用マニュアル。 |
| `vbt_report_*.txt` | アプリ終了時に自動生成される分析レポート。 |

## 4. 実行方法

### Webカメラ（リアルタイム計測）
```powershell
python app.py
```

### 動画ファイル解析
```powershell
python app.py --video video/test.mp4
```

### 操作キー
*   `Q`: 終了（レポートを保存して終了）
*   `C`: 強制キャリブレーション（通常は自動で行われるため不要）

## 5. ロジック詳細と注意点

### 速度計算アルゴリズム
*   `vbt_analyzer.py` 内 `calculate_velocity` メソッド。
*   前回フレームと現在フレームの手首（バー位置）のY座標差分と経過時間から算出。
*   平滑化のために移動平均フィルタ（window=5）を適用。

### レップ判定 (State Machine)
1.  **WAITING**: 静止状態。
2.  **ECCENTRIC**: 下降フェーズ（速度 < -閾値）。
3.  **CONCENTRIC**: 上昇フェーズ（速度 > +閾値）。ここでピーク速度を記録。
4.  上昇完了（速度低下）でレップ確定。

### 既知の課題・改善ポイント (Known Issues)

1.  **疲労度（Drop-off）計算のロジック**
    *   **現状**: 「1レップ目の速度」を基準（100%）として低下率を計算。
    *   **問題**: 1レップ目がウォームアップやノイズで極端に遅かった場合（例: 0.1m/s）、2レップ目が速いと低下率がマイナス（例: -2000%）になる。
    *   **修正案**: 基準値を「最初のNレップの最大値」にするか、「セッション全体での最大値（Absolute Peak）」を動的に更新して基準にする修正が必要。

2.  **キャリブレーション精度**
    *   **現状**: 左右の手首間距離を固定値 `0.81m` (81cmライン想定) と仮定している。
    *   **改善案**: ユーザーが独自の値を入力できるUIや、プレートの直径（45cm）など別の基準を使えるオプションの実装。

3.  **ノイズ対策**
    *   非常に小さな動きでもレップとして誤検知する場合がある。`process_rep` 内で「最低挙上距離」や「最低ピーク速度」の判定を追加することを推奨。

## 6. 最新の作業履歴
直近の実行ログ (`vbt_report_20251217_130247.txt`) では、上記の問題点1によりDrop-offがマイナス値になっていることが確認されています。次回の開発ではこのロジック修正から着手するのがスムーズです。
